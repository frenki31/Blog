@model BlogPostViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<BR_ApplicationUser> userManager;
@{
    var authUser = new BR_ApplicationUser();
    authUser = userManager.Users.FirstOrDefault(x => x.UserName == User.Identity!.Name);
}
<h3 class="mb-5">
    @{
        string number = Model.Post!.Comments!.Count() != 1 ? $"{Model.Post.Comments!.Count()} Comments" : "1 Comment";
    }
    @number
</h3>
<ul class="comment-list comment-top" list="@Model.Post.Comments" count="0">
    @foreach (var comment in Model.Post.Comments!.Where(comment => comment.ParentComment is null))
    {
        <li class="comment mt-5">
            <div class="comment-body">
                <div class="row">
                    <div class="col-lg-8 col-md-10">
                        <h4 class="commenter-name">@comment.ApplicationUser!.FirstName @comment.ApplicationUser.LastName (@comment.ApplicationUser.UserName)</h4>
                        <div class="comment-date">@comment.Created.ToString("MMMM d, yyyy hh:mm tt")</div>
                        <p class="comment-message">@comment.Message</p>
                        @if (!User.Identity!.IsAuthenticated)
                        {
                            <a class="btn btn-default" asp-action="Login" asp-controller="Login" asp-area="Admin" asp-route-url="@Model.ReturnUrl">Login to reply</a>
                        }
                        else
                        {
                            <a aria-expanded="false" data-target="@($"#replyComment{comment.IDBR_Comment}")" data-toggle="collapse" class="btn reply-btn">Reply</a>
                        }
                    </div>
                    <div class="col-2">
                        @if (User.Identity.IsAuthenticated)
                        {
                            if (authUser!.UserName == comment.ApplicationUser.UserName || User.IsInRole("Admin"))
                            {
                                <form method="post" asp-action="DeleteComment" asp-controller="Blog" asp-route-id="@comment.IDBR_Comment" asp-route-slug="@Model.Post.Slug" onsubmit="return confirm('Do you want to delete this comment?')">
                                    <input type="submit" class="btn btn-outline-danger" value="Delete" />
                                </form>
                            }
                        }
                    </div>
                </div>
            </div>
            @if (User.Identity.IsAuthenticated)
            {
                <div class="collapse" id="@($"replyComment{comment.IDBR_Comment}")">
                    <form asp-controller="Blog" asp-action="Comment">
                        <input asp-for="Post!.IDBR_Post" readonly hidden />
                        <input asp-for="Comment!.ParentComment!.IDBR_Comment" value="@comment.IDBR_Comment" readonly hidden />
                        <div class="form-group">
                            <label>Write a reply</label>
                            <textarea asp-for="Comment!.Message" class="form-control" rows="3"></textarea>
                            <button class="btn btn-outline-primary post-btn" type="submit">Comment</button>
                        </div>
                    </form>
                </div>
            }
            <ul class="comment-list">
                @foreach (var reply in comment.Replies!)
                {
                    <li class="comment">
                        <div class="comment-body">
                            <div class="row">
                                <div class="col-lg-8 col-md-10">
                                    <h5 class="commenter-name">@reply.ApplicationUser!.FirstName @reply.ApplicationUser.LastName (@reply.ApplicationUser.UserName)</h5>
                                    <div class="comment-date">@reply.Created.ToString("MMMM d, yyyy hh:mm tt")</div>
                                    <p class="comment-message">@reply.Message</p>
                                </div>
                                <div class="col-2">
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        if (authUser!.UserName == reply.ApplicationUser!.UserName || User.IsInRole("Admin"))
                                        {
                                            <form method="post" asp-action="DeleteComment" asp-controller="Blog" asp-route-id="@reply.IDBR_Comment" asp-route-slug="@Model.Post.Slug" onsubmit="return confirm('Do you want to delete this comment?')">
                                                <input type="submit" class="btn btn-outline-danger" value="Delete" />
                                            </form>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </li>
                }
            </ul>
        </li>
        <hr>
    }
</ul>
@if (User.Identity!.IsAuthenticated)
{
    <div class="mb-4">
        <form asp-controller="Blog" asp-action="Comment">
            <input asp-for="Post!.IDBR_Post" readonly hidden />
            <label>Comment</label>
            <textarea asp-for="Comment!.Message" class="form-control" rows="3" required></textarea>
            <button class="btn btn-outline-primary post-btn" type="submit">Comment</button>
        </form>
    </div>
}
else
{
    <a class="btn btn-default" asp-action="Login" asp-controller="Login" asp-area="Admin" asp-route-url="@Model.ReturnUrl">Login to comment</a>
}