@model BlogPostViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> userManager;
@{
    ViewData["Title"] = "Post";
    ViewData["Description"] = Model.Post!.ShortDescription;
    ViewData["Keywords"] = $"{Model.Post.Tags?.Replace(",","")} {Model.Post.Category}";
    string imageUrl = "";
    if (Model.Post.Image == null)
    {
        imageUrl = "assets/img/post-bg.jpg";
    }
    else
    {
        imageUrl = "/images/" + Model.Post.Image;
    }

    var authUser = new ApplicationUser();
    authUser = userManager.Users.FirstOrDefault(x => x.UserName == User.Identity!.Name);
}
@{
    await Html.RenderPartialAsync("_Navbar");
}
<!-- Page Header-->
<header class="masthead" style="background-image: url('@imageUrl')">
    <div class="container position-relative px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                <div class="post-heading">
                    <h1>@Model.Post.Title</h1>
                    <h2 class="subheading">@Model.Post.ShortDescription</h2>
                    <span class="meta">
                        Posted by
                        <a asp-action="Profile" asp-controller="Home" asp-route-id="@Model.Post.User!.Id">@Model.Post.Author</a>
                        on @Model.Post.publicationDate.ToShortDateString()
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- Post Content-->
<article class="mb-4">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-md-10 col-lg-8 col-xl-7">
                @Html.Raw(Model.Post.Description)
            </div>
        </div>
    </div>
</article>
<div class="container">
    <div class="row mt-5">
        <div class="col-lg-8 col-md-10 mx-auto">
            @if (Model.Post.Document != null)
            {
                <form method="post" asp-action="Download" asp-controller="Home" asp-route-id="@Model.Post.Document.Id">
                    <input type="submit" class="btn btn-primary" value="Download" />
                </form>
            }
            <h3 class="mb-5">
                @{
                    string number = Model.Post.Comments!.Count() != 1 ? $"{Model.Post.Comments!.Count()} Comments" : "1 Comment";
                }
                @number
            </h3>
            <ul class="comment-list comment-top" list="@Model.Post.Comments" count="0">
                @foreach (var comment in Model.Post.Comments!.Where(comment => comment.ParentComment is null))
                {
                    <li class="comment mt-5">
                        <div class="comment-body">
                            <div class="row">
                                <div class="col-lg-8 col-md-10">
                                    <h4 class="commenter-name">@comment.User!.FirstName @comment.User.LastName (@comment.User.UserName)</h4>
                                    <div class="comment-date">@comment.Created.ToString("MMMM d, yyyy hh:mm tt")</div>
                                    <p class="comment-message">@comment.Message</p>
                                    @if (!User.Identity!.IsAuthenticated)
                                    {
                                        <a class="btn btn-default" asp-action="Login" asp-controller="User" asp-area="Admin" asp-route-url="@Model.ReturnUrl">Login to reply</a>
                                    }
                                    else
                                    {
                                        <a aria-expanded="false" data-target="@($"#replyComment{comment.Id}")" data-toggle="collapse" class="btn reply-btn">Reply</a>
                                    }
                                </div>
                                <div class="col-2">
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        if (authUser!.UserName == comment.User.UserName || User.IsInRole("Admin"))
                                        {
                                            <form method="post" asp-action="DeleteComment" asp-controller="Blog" asp-route-id="@comment.Id" asp-route-slug="@Model.Post.Slug" onsubmit="return confirm('Do you want to delete this comment?')">
                                                <input type="submit" class="btn btn-outline-danger" value="Delete" />
                                            </form>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        @if (User.Identity.IsAuthenticated)
                        {
                            <div class="collapse" id="@($"replyComment{comment.Id}")">
                                <form asp-controller="Blog" asp-action="Comment">
                                    <input asp-for="Post!.Id" readonly hidden />
                                    <input asp-for="Comment!.ParentComment!.Id" value="@comment.Id" readonly hidden />
                                    <div class="form-group">
                                        <label>Write a reply</label>
                                        <textarea asp-for="Comment!.Message" class="form-control" rows="3"></textarea>
                                        <button class="btn btn-outline-primary post-btn" type="submit">Comment</button>
                                    </div>
                                </form>
                            </div>
                        }
                        <ul class="comment-list">
                            @foreach (var reply in comment.Replies!)
                            {
                                <li class="comment">
                                    <div class="comment-body">
                                        <div class="row">
                                            <div class="col-lg-8 col-md-10">
                                                <h5 class="commenter-name">@reply.User!.FirstName @reply.User.LastName (@reply.User.UserName)</h5>
                                                <div class="comment-date">@reply.Created.ToString("MMMM d, yyyy hh:mm tt")</div>
                                                <p class="comment-message">@reply.Message</p>
                                            </div>
                                            <div class="col-2">
                                                @if (User.Identity.IsAuthenticated)
                                                {
                                                    if (authUser!.UserName == reply.User!.UserName || User.IsInRole("Admin"))
                                                    {
                                                        <form method="post" asp-action="DeleteComment" asp-controller="Blog" asp-route-id="@reply.Id" asp-route-slug="@Model.Post.Slug" onsubmit="return confirm('Do you want to delete this comment?')">
                                                            <input type="submit" class="btn btn-outline-danger" value="Delete" />
                                                        </form>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </li>
                    <hr>
                }
            </ul>
            @if (User.Identity!.IsAuthenticated)
            {
                <div class="mb-4">
                    <form asp-controller="Blog" asp-action="Comment">
                        <input asp-for="Post!.Id" readonly hidden/>
                        <label>Comment</label>
                        <textarea asp-for="Comment!.Message" class="form-control" rows="3" required></textarea>
                        <button class="btn btn-outline-primary post-btn" type="submit">Comment</button>
                    </form>
                </div>
            }
            else
            {
                <a class="btn btn-default" asp-action="Login" asp-controller="User" asp-area="Admin" asp-route-url="@Model.ReturnUrl">Login to comment</a>
            }
        </div>
    </div>
</div>
@{
    await Html.RenderPartialAsync("_Footer");
}
@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $(".reply-btn").click(function (e) {
                e.preventDefault();
                var target = $(this).data('target');
                $(target).collapse('toggle');
            });
        });
    </script>
}


